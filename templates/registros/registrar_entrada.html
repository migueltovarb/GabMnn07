{% extends 'base.html' %}
{% load static %}

{% block title %}Registrar Entrada - Sistema de Gestión{% endblock %}

{% block content %}
<div class="form-container" style="max-width: 500px;">
    <h2 class="form-title">
        <i class="fas fa-arrow-right" style="color: #27ae60;"></i> Registrar Entrada
    </h2>

    <form method="post" novalidate>
        {% csrf_token %}

        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin-bottom: 25px; display: flex; gap: 10px;">
            <i class="fas fa-check-circle" style="min-width: 20px; font-size: 18px;"></i>
            <div>
                <p style="margin: 0; font-weight: 600;">Registro de Entrada</p>
                <p style="margin: 5px 0 0 0; font-size: 13px;">Selecciona el visitante y registra su hora de entrada al edificio.</p>
            </div>
        </div>

        <div class="form-group required">
            <label for="id_visitante">
                <i class="fas fa-user-tie"></i> Visitante
            </label>
            <select name="visitante" id="id_visitante" required {% if form.visitante.errors %}class="form-error"{% endif %}>
                <option value="">-- Selecciona un visitante --</option>
                {% for visitante in form.visitante.field.queryset %}
                <option value="{{ visitante.id }}">
                    {{ visitante.nombre }} ({{ visitante.documento }})
                </option>
                {% endfor %}
            </select>
            <p class="form-help"><i class="fas fa-info-circle"></i> Debe estar previamente registrado en el sistema</p>
            {% if form.visitante.errors %}
            <ul class="errorlist">
                {% for error in form.visitante.errors %}<li>{{ error }}</li>{% endfor %}
            </ul>
            {% endif %}
        </div>

        <div class="form-group required">
            <label for="id_hora_entrada">
                <i class="fas fa-clock"></i> Hora de Entrada
            </label>
            <input 
                type="datetime-local" 
                name="hora_entrada" 
                id="id_hora_entrada"
                required
                {% if form.hora_entrada.errors %}class="form-error"{% endif %}
            >
            <p class="form-help">La hora actual se cargará automáticamente</p>
            {% if form.hora_entrada.errors %}
            <ul class="errorlist">
                {% for error in form.hora_entrada.errors %}<li>{{ error }}</li>{% endfor %}
            </ul>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_observaciones">
                <i class="fas fa-sticky-note"></i> Observaciones (Opcional)
            </label>
            <textarea 
                name="observaciones" 
                id="id_observaciones"
                placeholder="Notas sobre la entrada (acompañante, paquetes, etc.)"
                {% if form.observaciones.errors %}class="form-error"{% endif %}
            ></textarea>
            {% if form.observaciones.errors %}
            <ul class="errorlist">
                {% for error in form.observaciones.errors %}<li>{{ error }}</li>{% endfor %}
            </ul>
            {% endif %}
        </div>

        {% if form.non_field_errors %}
        <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 25px;">
            <i class="fas fa-exclamation-circle"></i> 
            {% for error in form.non_field_errors %}<p style="margin: 5px 0 0 0;">{{ error }}</p>{% endfor %}
        </div>
        {% endif %}

        <div class="form-buttons">
            <button type="submit" class="btn btn-success btn-block">
                <i class="fas fa-arrow-right"></i> Registrar Entrada
            </button>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-block">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>

    <!-- Quick Stats -->
    <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center;">
        <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">
            <i class="fas fa-info-circle"></i> Total de visitantes registrados: <strong>{{ visitantes_count }}</strong>
        </p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const horaEntradaInput = document.getElementById('id_hora_entrada');
        
        // Auto-llenar con la hora actual si no está lleno
        if (!horaEntradaInput.value) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            horaEntradaInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }
    });
</script>

{% endblock %}